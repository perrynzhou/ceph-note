### BluStore和PG理解

| 作者 | 时间 |QQ技术交流群 |
| ------ | ------ |------ |
| perrynzhou@gmail.com |2021/04/01 |672152841 |


#### BluStore 存储了什么？采用什么样的策略写？

- BluStore存储磁盘分配信息、数据对象元数据、Ceph的omap数据信息。BluStore写数据采用了COW和RMW策略，任何一个写请求，根据磁盘块大小切分为三个部分，即首尾块大小非对齐部分和中间对齐部分，然后针对中间块对齐部分写入采用COW策略；首尾非对齐块部分采用RMW策略。由于RMW策略存在数据损坏或者数据丢失风险，还需要引入日志，即将对应数据写入到日志盘后采取真正的跟新数据盘，数据盘更新后才能释放日志。


- BluStore 提供读和写两种多线程访问接口，这接口访问的细粒度是以PG为基本单位。所有读请求都是同步，写请求处于效率考虑一般是异步方式。通过BlueStore提供接口操作PG下的某个对象，首先需要找到BlueStore中对应的PG和数据对象的上下文，这两类信息保存了关键PG和数据对象的元数据信息，BlueStore通过Rocksdb将这些数据保存在磁盘。Rocksdb分为WAL和DB,针对BlueStore中，WAL用来保存首尾非对齐块写操作，然后在更新数据，而DB部分则是保存了磁盘分配、对象、omap的元数据，在一个正常集群中如果这些数据所在磁盘损坏，这个OSD对应的数据基本是损坏的。
- BluStore 中实现大量数据结构，每种数据结构有内存和磁盘两种格式，磁盘格式以 `_t`结尾并且全部小写，而内存格式不以为`_t`结尾并且只有首字母大写

#### PG 作用是什么？
- Ceph不是将上层数据直接映射到磁盘(OSD)而是引入了中间结构，这个称为Placement Group,简称为PG。
- Ceph数据采用了2级映射，第一级是静态的，负责将任何前端类型的应用数据按照对象大小进行切割、编号后作为伪随机哈希函数的输入，均匀映射到PG。第二级映射是实现PG到OSD的映射，这级映射仍然采用伪随机哈希函数(保证PG在OSD之间分布式均匀的)，但是输入不仅仅是PGID，同时还需要集群拓扑信息、Pool的CRUSH规则对计算过程进行调整，以帮助PG在不同OSD之间进行灵活迁移，从而实现数据可靠性、自动平衡等高级特性。最终Pool是以PG作为基本单位进行组织，因此PG实际是一些对象的逻辑载体
- 在同一个PG内所有对象其32位哈希值中低n个比特都是相同的，PG对应的磁盘数据结构是bluestore_cnode_t

#### 什么是PG分裂？
- 基于老的PG(祖先PG)产生新的孩子PG，并且新孩子PG中最初全部对象都来自于老的PG，这个过程称为PG 分裂
- Ceph集群中PG数量发生变化，此时执行前端对象到PG的映射时候哈希函数的输入之一的参数PG数目发生变化，会导致某些对象数据从来的PG重新映射到新的PG，这个过程是PG分裂，分裂一般按照如下步骤进行。
	- Monitor检测到pool中PG数目发生修改,发起并完成信息的同步，随后将包含变更的新OSDMap推送到相关的OSD。
	- OSD接受到新的OSDMap与自己老的OSDMap进行比较，判断对应的PG是否需要进行分裂，如果新老OSDMap中某个PG发生变化，则需要执行分裂。
